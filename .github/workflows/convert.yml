name: Convert Images for E-Paper

on:
  push:
    paths:
      - 'input/**'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install pillow numpy
      
      - name: Process new image
        run: |
          mkdir -p image output
          
          # Trova solo i file nuovi in questo commit
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- 'input/*.jpg' 'input/*.jpeg' 'input/*.png' 'input/*.JPG' 'input/*.JPEG' 'input/*.PNG' 2>/dev/null || echo "")
          
          if [ -z "$NEW_FILES" ]; then
            echo "Nessun nuovo file in input/"
            exit 0
          fi
          
          # Prendi solo l'ultimo file nuovo
          LATEST=$(echo "$NEW_FILES" | tail -1)
          echo "Nuovo file: $LATEST"
          
          # Se esiste giÃ  un bmp in /image, spostalo in /output
          if ls image/*.bmp 1> /dev/null 2>&1; then
            echo "Sposto vecchio BMP in output/"
            mv image/*.bmp output/
          fi
          
          # Converti il nuovo file
          FILENAME=$(basename "$LATEST" | sed 's/\.[^.]*$//')
          python convert_for_epaper.py "$LATEST" "image/${FILENAME}.bmp"
      
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add image/ output/
          git diff --staged --quiet || git commit -m "ðŸ–¼ï¸ Nuovo BMP: $(ls image/*.bmp 2>/dev/null | head -1 | xargs basename)"
          git push
